# Copyright 2023 You-Sheng Yang and others
# SPDX-License-Identifier: FSFAP
# Copying and distribution of this file, with or without modification, are
# permitted in any medium without royalty provided the copyright notice and
# this notice are preserved. This file is offered as-is, without any warranty.
---
name: 'CI'
on:
  push:
    branches:
      - main
      - 'releases/v*'
    tags:
      - 'v*'
    paths-ignore:
      - LICENSE
      - 'README.*'
  pull_request:
    paths-ignore:
      - LICENSE
      - 'README.*'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  static-checks:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: 'Install prerequisites'
        run: |
          sudo apt-get update --quiet
          sudo apt-get install --no-install-recommends -y \
              licensecheck

      - name: 'Check license'
        run: |
          PROBLEMS=0

          BAD_FILES=$(licensecheck -r . | grep -Ev '(README.md)'| grep UNKNOWN) || true
          if [ -n "${BAD_FILES}" ]; then
            echo "ERROR: Missing license statement in the following files:"
            echo "$BAD_FILES"
            PROBLEMS=$(($PROBLEMS + 1))
          fi

          exit $PROBLEMS

      - name: 'reviewdog/shellcheck'
        uses: haya14busa/action-cond@v1
        id: reporter
        with:
          cond: ${{ github.event_name == 'pull_request' }}
          if_true: "github-pr-review"
          if_false: "github-check"
      - uses: reviewdog/action-shellcheck@v1
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          reporter: ${{ steps.reporter.outputs.value }}
          level: warning
          exclude: |
            */.git/*

  generate-matrix:
    runs-on: ubuntu-latest
    outputs:
      image-version: ${{ steps.image-version.outputs.image-version }}
      releases: ${{ steps.release.outputs.releases }}
      default_index: ${{ steps.release.outputs.default_index }}
      default_release: ${{ steps.release.outputs.default_release }}
    env:
      DEFAULT_RELEASE: 'unstable'
      IMAGE_VERSION: '0.0'
    steps:
      - name: Install prerequisites
        run: |
          echo "::group::Apt"
          sudo apt-get update --quiet
          sudo apt-get install --no-install-recommends --yes jq
          echo "::endgroup::"

          echo "::group::jq version"
          jq --version
          echo "::endgroup::"

      - name: Checking image version
        id: image-version
        run: |
          version="${IMAGE_VERSION}"
          case "${{ format('{0}:{1}', github.event_name, github.ref) }}" in
            push:refs/tags/*) version="${{ github.ref_name }}" ;;
            *) ;;
          esac

          echo "::group::Outputs"
          echo "image-version=${version}" | tee -a "${GITHUB_OUTPUT}"
          echo "::endgroup::"

      - name: Generate supported matrix
        id: release
        run: |
          releases_json="[]"
          for release in experimental unstable testing stable; do
            obj_json="{\"vendor\": \"debian\", \"release\": \"${release}\"}"

            content="$(wget -q -O - "https://deb.debian.org/debian/dists/${release}/Release" | grep -v '^ ')"

            archs=()
            for arch in $(echo "${content}" | awk '/^Architectures:/ {$1=""; $2=""; $0=$0; print $0}'); do
              # https://github.com/hustle-ci/debian-build-action/issues/5
              [ "${arch}" != "mipsel" ] || continue

              archs+=("${arch}")
            done
            obj_json="$(echo "${obj_json}" | jq -c -M ".architectures=\"${archs[*]}\"")"

            aliases=("${release}")
            aliases+=("$(echo "${content}" | awk '/^Codename:/ {print $2}')")
            [ "${release}" != "${DEFAULT_RELEASE}" ] || aliases+=(latest)
            obj_json="$(echo "${obj_json}" | jq -c -M ".aliases=\"${aliases[*]}\"")"

            releases_json="$(echo "${releases_json}" | jq -c -M ". + [${obj_json}]")"
          done

          default_index=$(echo "${releases_json}" | \
              jq ". | map(.release == \"${DEFAULT_RELEASE}\") | index(true)")

          echo "::group::Outputs"
          echo "releases=${releases_json}" | tee -a "${GITHUB_OUTPUT}"
          echo "default_index=${default_index}" | tee -a "${GITHUB_OUTPUT}"
          echo "default_release=${DEFAULT_RELEASE}" | tee -a "${GITHUB_OUTPUT}"
          echo "::endgroup::"

  base-images:
    runs-on: ubuntu-latest
    needs:
      - generate-matrix
      - static-checks
    strategy:
      matrix:
        include: ${{ fromJSON(needs.generate-matrix.outputs.releases) }}
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - uses: ./.github/actions/build-image
        with:
          vendor: ${{ matrix.vendor }}
          release: ${{ matrix.release }}
          architectures: ${{ matrix.architectures }}
          target: 'base'
          image_version: ${{ needs.generate-matrix.outputs.image-version }}
          tag_prefix: ${{ github.run_id }}-
          ghcr_password: ${{ secrets.GITHUB_TOKEN }}

  latest-amd64-images:
    runs-on: ubuntu-latest
    needs:
      - generate-matrix
      - base-images
    strategy:
      matrix:
        target:
          - 'gbp'
        include:
          - ${{ fromJSON(needs.generate-matrix.outputs.releases)[fromJSON(needs.generate-matrix.outputs.default_index)] }}
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - uses: ./.github/actions/build-image
        with:
          vendor: ${{ matrix.vendor }}
          release: ${{ matrix.release }}
          target: ${{ matrix.target }}
          image_version: ${{ needs.generate-matrix.outputs.image-version }}
          tag_prefix: ${{ github.run_id }}-
          ghcr_password: ${{ secrets.GITHUB_TOKEN }}

  tests:
    needs:
      - generate-matrix
      - base-images
      - latest-amd64-images
    uses: ./.github/workflows/tests.yml
    with:
      releases: ${{ needs.generate-matrix.outputs.releases }}
      default_release: ${{ needs.generate-matrix.outputs.default_release }}

  publish-staging-tags:
    needs:
      - generate-matrix
      - tests
    strategy:
      matrix:
        include: ${{ fromJSON(needs.generate-matrix.outputs.releases) }}
    permissions:
      contents: read
      packages: write
    uses: ./.github/workflows/publish-tags.yml
    with:
      vendor: ${{ matrix.vendor }}
      release: ${{ matrix.release }}
      aliases: ${{ matrix.aliases }}
      image-version: ${{ needs.generate-matrix.outputs.image-version }}
      dry-run: ${{ github.event_name == 'pull_request' }}

  prune-staging-tags:
    needs:
      - publish-staging-tags
    if: ${{ always() }}
    permissions:
      contents: read
      packages: write
    uses: ./.github/workflows/prune-staging-tags.yml
    with:
      prune-tags-regexes: |
        ^${{ github.run_id }}-
